(()=>{"use strict";(()=>{const e=["gif","jpg","jpeg","png"];function t(e,t){return Math.floor(e+Math.random()*(t+1-e))}window.utils={getRandomInteger:t,getRandomElement:function(e){return e[t(0,e.length-1)]},getCorrectOrderList:function(e){return e.filter((()=>t(0,1)))},getEnding:function(e,t){return t[e%100>4&&e%100<20?2:[2,0,1,1,1,2][e%10<5?e%10:5]]},setDisabled:function(e,t=!0){e.forEach((e=>{t?e.setAttribute("disabled",""):e.removeAttribute("disabled")}))},removeElements:function(e){e.forEach((e=>{e.remove()}))},checkInterval:function(e,t){return t<window.data.ADS_DATA[e].min?t=window.data.ADS_DATA[e].min:t>window.data.ADS_DATA[e].max&&(t=window.data.ADS_DATA[e].max),t},debounce:function(e){let t=null;return function(...o){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...o)}),500)}},getPhotoSrc:function(t,o){const n=t.files[0],r=n.name.toLowerCase();if(e.some((function(e){return r.endsWith(e)}))){const e=new FileReader;e.readAsDataURL(n),e.addEventListener("load",(function(){o(e.result)}))}}}})(),(()=>{const e="https://21.javascript.pages.academy/keksobooking/data",t="https://21.javascript.pages.academy/keksobooking",o={200:{type:"success",message:"Запрос успешно выполнен"},400:{type:"error",message:"Неверный запрос"},401:{type:"error",message:"Пользователь не авторизован"},404:{type:"error",message:"Ничего не найдено"},500:{type:"error",message:"Ошибка сервера"}};window.network={load:function(t,n){const r=new XMLHttpRequest;r.responseType="json",r.timeout=1e4,r.addEventListener("load",(function(){switch(o[r.status].type){case"success":t(r.response);break;case"error":n(o[r.status].message);break;default:n(`Статус ответа: ${r.status} ${r.statusText}`)}})),r.addEventListener("error",(function(){n("Произошла ошибка соединения")})),r.addEventListener("timeout",(function(){n(`Запрос не успел выполниться за ${r.timeout} мс`)})),r.open("GET",e),r.send()},upload:function(e,n,r){const i=new XMLHttpRequest;i.responseType="json",i.timeout=1e4,i.addEventListener("load",(function(){switch(o[i.status].type){case"success":n("Ваша заявка успешно отправлена");break;case"error":r(o[i.status].message);break;default:r(`Статус ответа: ${i.status} ${i.statusText}`)}})),i.addEventListener("error",(function(){r("Произошла ошибка соединения")})),i.addEventListener("timeout",(function(){r(`Запрос не успел выполниться за ${i.timeout} мс`)})),i.open("POST",t),i.send(e)}}})(),(()=>{const e=document.querySelector(".map").querySelector(".map__filters"),t=e.querySelector("#housing-type"),o=e.querySelector("#housing-price"),n=e.querySelector("#housing-rooms"),r=e.querySelector("#housing-guests"),i=e.querySelector("#housing-features").querySelectorAll('input[name="features"]'),a={middle:{MIN:1e4,MAX:5e4},low:{MIN:0,MAX:1e4},high:{MIN:5e4,MAX:Number.POSITIVE_INFINITY}};function s(e){const t=window.map.getCoordinats(!1).split(",");return Math.sqrt(Math.abs(Math.pow(t[0]-window.data.loadedAds[e].location.x,2)+Math.pow(t[1]-window.data.loadedAds[e].location.y,2)))}window.filter={filtering:function(){let e=[];return window.data.loadedAds.forEach(((s,d)=>{(function(e){const o=e.offer.type;return"any"===t.value||o===t.value})(s)&&function(e){const t=e.offer.price;return"any"===o.value||t>=a[o.value].MIN&&t<=a[o.value].MAX}(s)&&function(e){const t=String(e.offer.rooms);return"any"===n.value||t===n.value}(s)&&function(e){const t=String(e.offer.guests);return"any"===r.value||t===r.value}(s)&&!function(e){return[...i].some((t=>t.checked&&!e.offer.features.includes(t.value)))}(s)&&(e=function(e,t){const o=new Set(t);return o.add(e),[...o]}(d,e))})),e.sort((function(e,t){return s(e)-s(t)}))}}})(),(()=>{function e(e){window.modals.showDialogMessage("error",e,t)}function t(){window.network.load(window.data.saveLoadedAds,e)}window.data={ADS_DATA:{NUMBER_OF_ADS:5,TAG_SIZE:{width:50,height:70},LOCATION_X:{min:0,max:0},LOCATION_Y:{min:130,max:630}},TYPE_HOUSING:{bungalow:{minPrice:0,translate:"Бунгало"},flat:{minPrice:1e3,translate:"Квартира"},house:{minPrice:5e3,translate:"Дом"},palace:{minPrice:1e4,translate:"Дворец"}},loadedAds:[],saveLoadedAds:function(e){window.data.loadedAds=[],e.forEach((e=>{e.offer&&(e.restrictions=[],window.data.loadedAds.push(e))})),window.map.setMapActiveMode(),window.form.setFormActiveMode()},loadAds:t}})(),(()=>{const e=document.querySelector(".map").querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin");function o(){const t=e.querySelectorAll('button[data-name="map_pin"]');window.utils.removeElements(t)}window.pin={renderPins:function(n){o(),window.card.removeCards();const r=function(e){const o=document.createDocumentFragment();return e.slice(0,window.data.ADS_DATA.NUMBER_OF_ADS).forEach((e=>{const n=function(e){const o=t.cloneNode(!0),n=o.querySelector("img");return o.style=`left: ${e.location.x-window.data.ADS_DATA.TAG_SIZE.width/2}px; top: ${e.location.y-window.data.ADS_DATA.TAG_SIZE.height}px;`,n.src=e.author.avatar,n.alt=e.offer.title,o}(window.data.loadedAds[e]);n.dataset.id=e,n.dataset.name="map_pin",o.appendChild(n)})),o}(n);e.appendChild(r)},removePins:o,removeActivePins:function(){document.querySelectorAll(".map__pin--active").forEach((e=>{e.classList.remove("map__pin--active")}))}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pins"),o=document.querySelector("#card").content.querySelector(".map__card"),n=o.querySelector(".popup__features").querySelector(".popup__feature"),r=o.querySelector(".popup__photos").querySelector(".popup__photo");window.card={renderCard:function(){const e=document.querySelector(".map__pin--active").dataset.id,i=function(e){const t=o.cloneNode(!0),i=t.querySelector(".popup__features"),a=t.querySelector(".popup__photos");if(t.querySelector(".popup__avatar").src=e.author.avatar,t.querySelector(".popup__title").textContent=e.offer.title,t.querySelector(".popup__text--address").textContent=e.offer.address,t.querySelector(".popup__text--price").textContent=e.offer.price+"₽/ночь",t.querySelector(".popup__type").textContent=window.data.TYPE_HOUSING[e.offer.type].translate,t.querySelector(".popup__text--capacity").textContent=function(e){let t=`${e.offer.rooms} ${window.utils.getEnding(e.offer.rooms,["комната","комнаты","комнат"])} `;return t+=e.offer.guests?`для ${e.offer.guests} ${window.utils.getEnding(e.offer.guests,["гостя","гостей","гостей"])}`:"без гостей",t}(e),t.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`,e.offer.description?t.querySelector(".popup__description").textContent=e.offer.description:t.classList.add("hidden"),e.offer.features){const t=function(e){const t=document.createDocumentFragment();return e.forEach((e=>{const o=n.cloneNode(!0);o.className="popup__feature popup__feature--"+e,t.appendChild(o)})),t}(e.offer.features);i.innerHTML="",i.appendChild(t)}else i.classList.add("hidden");if(e.offer.photos){const t=function(e){const t=document.createDocumentFragment();return e.forEach((e=>{const o=r.cloneNode(!0);o.src=e,t.appendChild(o)})),t}(e.offer.photos);a.innerHTML="",a.appendChild(t)}else a.classList.add("hidden");return t}(window.data.loadedAds[e]);t.after(i)},removeCards:function(){const t=e.querySelectorAll('article[class="map__card popup"]');window.utils.removeElements(t),window.pin.removeActivePins()}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pins"),o=t.querySelector(".map__pin--main"),n=e.querySelector(".map__filters"),r=n.querySelectorAll('[id^="housing-"]');function i(t=!0){const n=e.getBoundingClientRect(),r=o.getBoundingClientRect();return`${Math.round(r.left-n.left+r.width/2)}, ${Math.round(r.top-n.top+(!t&&o.scrollHeight||r.height/2))}`}function a(t){const o=t.target.closest('button[class="map__pin"]');o&&(window.card.removeCards(),o.classList.add("map__pin--active"),window.card.renderCard(),e.querySelector(".popup__close").addEventListener("click",l))}function s(){window.pin.removePins(),window.card.removeCards(),window.utils.debounce(window.pin.renderPins(window.filter.filtering()))}function d(e){0===e.button&&window.utils.debounce(a(e))}function c(e){switch(e.key){case"Enter":window.utils.debounce(a(e));break;case"Escape":e.preventDefault(),window.card.removeCards()}}function u(){window.utils.debounce(window.pin.renderPins(window.filter.filtering()))}function l(e){e.target.removeEventListener("click",l),window.card.removeCards()}window.map={getCoordinats:i,updateMap:s,setMapInactiveMode:function(){e.classList.add("map--faded"),window.utils.setDisabled(r),window.data.loadedAds=[],n.reset(),window.pin.removePins(),window.card.removeCards(),o.style="left: 570px; top: 375px;",window.form.setAdFormAddress(i(!0)),t.removeEventListener("click",d),t.removeEventListener("keydown",c),n.removeEventListener("change",u)},setMapActiveMode:function(){e.classList.remove("map--faded"),window.utils.setDisabled(r,!1),s(),t.addEventListener("click",d),t.addEventListener("keydown",c),n.addEventListener("change",u)}}})(),(()=>{const e={1:{values:["1"],textError:"1 комната — «для 1 гостя»"},2:{values:["1","2"],textError:"для 2 гостей» или «для 1 гостя»"},3:{values:["1","2","3"],textError:"«для 3 гостей», «для 2 гостей» или «для 1 гостя»"},100:{values:["0"],textError:"«не для гостей»"}},t=document.querySelector(".ad-form"),o=t.querySelector(".ad-form__submit"),n=t.querySelector(".ad-form__reset"),r=t.querySelectorAll("fieldset"),i=t.querySelector("#type"),a=t.querySelector("#price"),s=t.querySelector("#timein"),d=t.querySelector("#timeout"),c=t.querySelector("#room_number"),u=t.querySelector("#capacity"),l=t.querySelector(".ad-form-header__upload input[type=file]"),p=t.querySelector(".ad-form-header__upload .ad-form-header__preview img"),f=t.querySelector(".ad-form__upload input[type=file]"),m=t.querySelector(".ad-form__photo");function w(){a.min=0,a.placeholder=0,p.src="img/muffin-grey.svg",m.innerHTML="",t.reset(),window.map.setMapInactiveMode(),L()}function v(e){window.modals.showDialogMessage("success",e),w()}function _(e){window.modals.showDialogMessage("error",e,y)}function y(){window.network.upload(new FormData(t),v,_)}function h(o){!function(){const e=i.value,t=window.data.TYPE_HOUSING[e].minPrice;a.min=t,a.placeholder=t}(),function(){const e=d.value===s.value?"":"Время выезда должно быть до "+s.value;d.setCustomValidity(e),d.reportValidity()}(),function(){const t=c.value,o=u.value,n=e[t].values.includes(o)?"":e[t].textError;u.setCustomValidity(n),u.reportValidity()}(),t.checkValidity()&&(o.preventDefault(),y())}function g(e){0===e.button&&(e.preventDefault(),w())}function S(e){p.src=e}function A(){window.utils.getPhotoSrc(l,S)}function E(e){m.innerHTML=`<img src="${e}" alt="Фотография жилья" style="width: 100%; height: 100%; object-fit: contain">`}function q(){window.utils.getPhotoSrc(f,E)}function L(){t.classList.add("ad-form--disabled"),window.utils.setDisabled(r),o.removeEventListener("click",h),n.removeEventListener("click",g),l.removeEventListener("change",A),f.removeEventListener("change",q)}window.form={setAdFormAddress:function(e){t.address.value=e},setFormInactiveMode:L,setFormActiveMode:function(){t.classList.remove("ad-form--disabled"),window.utils.setDisabled(r,!1),o.addEventListener("click",h),n.addEventListener("click",g),l.addEventListener("change",A),f.addEventListener("change",q)},uploadAdForm:y}})(),window.modals={showDialogMessage:function(e,t,o){function n(){window.utils.removeElements(document.body.querySelectorAll(".user-message-active")),document.removeEventListener("click",r),document.removeEventListener("keydown",i)}function r(e){n(),o&&e.target.matches("button")&&o()}function i(e){"Escape"===e.key&&n()}const a=document.querySelector("#"+e).content.querySelector("."+e).cloneNode(!0);a.querySelector(`.${e}__message`).textContent=t||e,a.classList.add("user-message-active"),document.body.prepend(a),document.addEventListener("click",r),document.addEventListener("keydown",i)}},(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main");window.map.setMapInactiveMode(),window.form.setFormInactiveMode(),t.addEventListener("mousedown",(function(o){if(0!==o.button)return;o.preventDefault();let n={x:o.clientX,y:o.clientY};function r(e){e.preventDefault();let o=n.x-e.clientX,r=n.y-e.clientY;n={x:e.clientX,y:e.clientY},function(){const e=document.querySelector(".map__overlay");window.data.ADS_DATA.LOCATION_X.min=0-t.offsetWidth/2,window.data.ADS_DATA.LOCATION_X.max=e.offsetWidth-t.offsetWidth/2}(),t.style.top=window.utils.checkInterval("LOCATION_Y",t.offsetTop-r)+"px",t.style.left=window.utils.checkInterval("LOCATION_X",t.offsetLeft-o)+"px"}document.addEventListener("mousemove",r),document.addEventListener("mouseup",(function t(o){o.preventDefault(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",t),e.matches(".map--faded")&&window.data.loadAds(),window.form.setAdFormAddress(window.map.getCoordinats(!1)),window.map.updateMap()}))}))})()})();