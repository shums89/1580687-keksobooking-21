(()=>{"use strict";(()=>{const e=["gif","jpg","jpeg","png"];window.utils={getWordEnding:function(e,t){return t[e%100>4&&e%100<20?2:[2,0,1,1,1,2][e%10<5?e%10:5]]},setDisabled:function(e,t=!0){e.forEach((e=>{t?e.setAttribute("disabled",""):e.removeAttribute("disabled")}))},removeElements:function(e){e.forEach((e=>{e.remove()}))},debounce:function(e){let t=null;return function(...n){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...n)}),500)}},getPhotoSrc:function(t,n){const o=t.files[0],r=o.name.toLowerCase();if(e.some((e=>r.endsWith(e)))){const e=new FileReader;e.readAsDataURL(o),e.addEventListener("load",(()=>n(e.result)))}}}})(),(()=>{const e="https://21.javascript.pages.academy/keksobooking/data",t="https://21.javascript.pages.academy/keksobooking",n={400:"Неверный запрос",401:"Пользователь не авторизован",404:"Ничего не найдено",500:"Ошибка сервера"};window.network={load:function(t,o){const r=new XMLHttpRequest;r.responseType="json",r.timeout=1e4,r.addEventListener("load",(()=>{t(r.response)})),r.addEventListener("error",(()=>{o(n[r.status]||"Произошла ошибка соединения")})),r.addEventListener("timeout",(function(){o(`Запрос не успел выполниться за ${r.timeout} мс`)})),r.open("GET",e),r.send()},upload:function(e,o,r){const i=new XMLHttpRequest;i.responseType="json",i.timeout=1e4,i.addEventListener("load",(function(){o("Ваша заявка успешно отправлена")})),i.addEventListener("error",(function(){r(n[i.status]||"Произошла ошибка соединения")})),i.addEventListener("timeout",(function(){r(`Запрос не успел выполниться за ${i.timeout} мс`)})),i.open("POST",t),i.send(e)}}})(),(()=>{const e=document.querySelector(".map").querySelector(".map__filters"),t=e.querySelector("#housing-type"),n=e.querySelector("#housing-price"),o=e.querySelector("#housing-rooms"),r=e.querySelector("#housing-guests"),i=e.querySelector("#housing-features").querySelectorAll('input[name="features"]'),a={middle:{MIN:1e4,MAX:5e4},low:{MIN:0,MAX:1e4},high:{MIN:5e4,MAX:Number.POSITIVE_INFINITY}};function c(e){const t=window.map.getCoordinats(!1).split(",");return Math.sqrt(Math.abs(Math.pow(t[0]-e.location.x,2)+Math.pow(t[1]-e.location.y,2)))}window.filter={getFilterData:function(e){return function(e){return e.sort((function(e,t){return c(e)-c(t)}))}(e.filter((e=>function(e){const n=e.offer.type;return"any"===t.value||n===t.value}(e)&&function(e){const t=e.offer.price;return"any"===n.value||t>=a[n.value].MIN&&t<=a[n.value].MAX}(e)&&function(e){const t=String(e.offer.rooms);return"any"===o.value||t===o.value}(e)&&function(e){const t=String(e.offer.guests);return"any"===r.value||t===r.value}(e)&&!function(e){return[...i].some((t=>t.checked&&!e.offer.features.includes(t.value)))}(e))))}}})(),(()=>{const e={NUMBER_OF_ADS:5,LOCATION_X:{min:0,max:0},LOCATION_Y:{min:130,max:630}};window.data={ADS_DATA:e,TYPE_HOUSING:{bungalow:{minPrice:0,translate:"Бунгало"},flat:{minPrice:1e3,translate:"Квартира"},house:{minPrice:5e3,translate:"Дом"},palace:{minPrice:1e4,translate:"Дворец"}},loadedAds:[],checkInterval:function(t,n){return n<e[t].min?n=e[t].min:n>e[t].max&&(n=e[t].max),n}}})(),(()=>{const e=document.querySelector(".map").querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin");function n(){const t=e.querySelectorAll('button[data-name="map_pin"]');window.utils.removeElements(t)}window.pin={renderPins:function(o){n(),window.card.removeCard();const r=function(e){const n=document.createDocumentFragment();return e.slice(0,window.data.ADS_DATA.NUMBER_OF_ADS).forEach((e=>{const o=function(e){const n=t.cloneNode(!0),o=n.querySelector("img");return n.style=`left: ${e.location.x-25}px; top: ${e.location.y-70}px;`,o.src=e.author.avatar,o.alt=e.offer.title,n}(e);o.dataset.id=e.index,o.dataset.name="map_pin",n.appendChild(o)})),n}(o);e.appendChild(r)},removePins:n,removeActivePin:function(){const e=document.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active")}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pins"),n=document.querySelector("#card").content.querySelector(".map__card"),o=n.querySelector(".popup__features").querySelector(".popup__feature"),r=n.querySelector(".popup__photos").querySelector(".popup__photo");function i(e){e.target.removeEventListener("click",i),window.card.removeCard()}window.card={renderCard:function(a){const c=function(e){const t=n.cloneNode(!0),i=t.querySelector(".popup__description"),a=t.querySelector(".popup__features"),c=t.querySelector(".popup__photos");if(t.querySelector(".popup__avatar").src=e.author.avatar,t.querySelector(".popup__title").textContent=e.offer.title,t.querySelector(".popup__text--address").textContent=e.offer.address,t.querySelector(".popup__text--price").textContent=e.offer.price+"₽/ночь",t.querySelector(".popup__type").textContent=window.data.TYPE_HOUSING[e.offer.type].translate,t.querySelector(".popup__text--capacity").textContent=function(e){let t=`${e.offer.rooms} ${window.utils.getWordEnding(e.offer.rooms,["комната","комнаты","комнат"])} `;return t+=e.offer.guests?`для ${e.offer.guests} ${window.utils.getWordEnding(e.offer.guests,["гостя","гостей","гостей"])}`:"без гостей",t}(e),t.querySelector(".popup__text--time").textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`,e.offer.description?i.textContent=e.offer.description:i.classList.add("hidden"),e.offer.features){const t=function(e){const t=document.createDocumentFragment();return e.forEach((e=>{const n=o.cloneNode(!0);n.className="popup__feature popup__feature--"+e,t.appendChild(n)})),t}(e.offer.features);a.innerHTML="",a.appendChild(t)}else a.classList.add("hidden");if(e.offer.photos){const t=function(e){const t=document.createDocumentFragment();return e.forEach((e=>{const n=r.cloneNode(!0);n.src=e,t.appendChild(n)})),t}(e.offer.photos);c.innerHTML="",c.appendChild(t)}else c.classList.add("hidden");return t}(window.data.loadedAds[a]);t.after(c),e.querySelector(".popup__close").addEventListener("click",i)},removeCard:function(){const t=e.querySelector('article[class="map__card popup"]');t&&t.remove(),window.pin.removeActivePin()}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pins"),n=t.querySelector(".map__pin--main"),o=e.querySelector(".map__filters"),r=o.querySelectorAll('[id^="housing-"]');function i(t=!0){const o=e.getBoundingClientRect(),r=n.getBoundingClientRect();return`${Math.round(r.left-o.left+r.width/2)}, ${Math.round(r.top-o.top+(!t&&n.scrollHeight||r.height/2))}`}function a(e){window.data.loadedAds=[],e.forEach(((e,t)=>{e.offer&&(e.index=t,window.data.loadedAds.push(e))})),u(),t.addEventListener("click",l),t.addEventListener("keydown",p),o.addEventListener("change",f)}function c(e){window.modals.showDialogMessage("error",e,d)}function d(){window.network.load(a,c)}function s(e){const t=e.target.closest(".map__pin:not(.map__pin--main)");t&&(window.card.removeCard(),t.classList.add("map__pin--active"),window.card.renderCard(t.dataset.id))}function u(){window.form.setAdFormAddress(i(!1)),window.pin.removePins(),window.card.removeCard();const e=window.filter.getFilterData(window.data.loadedAds);window.utils.debounce(window.pin.renderPins(e))}function l(e){0===e.button&&window.utils.debounce(s(e))}function p(e){switch(e.key){case"Enter":window.utils.debounce(s(e));break;case"Escape":e.preventDefault(),window.card.removeCard()}}function f(){const e=window.filter.getFilterData(window.data.loadedAds);window.utils.debounce(window.pin.renderPins(e))}window.map={getCoordinats:i,updateMap:u,deactivateMap:function(){e.classList.add("map--faded"),window.utils.setDisabled(r),window.data.loadedAds=[],o.reset(),window.pin.removePins(),window.card.removeCard(),n.style="left: 570px; top: 375px;",window.form.setAdFormAddress(i(!0)),t.removeEventListener("click",l),t.removeEventListener("keydown",p),o.removeEventListener("change",f)},activateMap:function(){e.classList.remove("map--faded"),window.utils.setDisabled(r,!1),d()}}})(),(()=>{const e={1:{values:["1"],textError:"1 комната — «для 1 гостя»"},2:{values:["1","2"],textError:"для 2 гостей» или «для 1 гостя»"},3:{values:["1","2","3"],textError:"«для 3 гостей», «для 2 гостей» или «для 1 гостя»"},100:{values:["0"],textError:"«не для гостей»"}},t=document.querySelector(".ad-form"),n=t.querySelector(".ad-form__submit"),o=t.querySelector(".ad-form__reset"),r=t.querySelectorAll("fieldset"),i=t.querySelector("#type"),a=t.querySelector("#price"),c=t.querySelector("#timein"),d=t.querySelector("#timeout"),s=t.querySelector("#room_number"),u=t.querySelector("#capacity"),l=t.querySelector(".ad-form-header__upload input[type=file]"),p=t.querySelector(".ad-form-header__upload .ad-form-header__preview img"),f=t.querySelector(".ad-form__upload input[type=file]"),m=t.querySelector(".ad-form__photo");function w(){a.min=0,a.placeholder=0,p.src="img/muffin-grey.svg",m.innerHTML="",t.reset(),window.map.deactivateMap(),A()}function v(e){window.modals.showDialogMessage("success",e),w()}function y(e){window.modals.showDialogMessage("error",e,_)}function _(){window.network.upload(new FormData(t),v,y)}function h(n){!function(){const e=i.value,t=window.data.TYPE_HOUSING[e].minPrice;a.min=t,a.placeholder=t}(),function(){const e=d.value===c.value?"":"Время выезда должно быть до "+c.value;d.setCustomValidity(e),d.reportValidity()}(),function(){const t=s.value,n=u.value,o=e[t].values.includes(n)?"":e[t].textError;u.setCustomValidity(o),u.reportValidity()}(),t.checkValidity()&&(n.preventDefault(),_())}function S(e){0===e.button&&(e.preventDefault(),w())}function g(e){p.src=e}function q(){window.utils.getPhotoSrc(l,g)}function E(e){m.innerHTML=`<img src="${e}" alt="Фотография жилья" style="width: 100%; height: 100%; object-fit: contain">`}function L(){window.utils.getPhotoSrc(f,E)}function A(){t.classList.add("ad-form--disabled"),window.utils.setDisabled(r),n.removeEventListener("click",h),o.removeEventListener("click",S),l.removeEventListener("change",q),f.removeEventListener("change",L)}window.form={setAdFormAddress:function(e){t.address.value=e},setFormInactiveMode:A,setFormActiveMode:function(){t.classList.remove("ad-form--disabled"),window.utils.setDisabled(r,!1),n.addEventListener("click",h),o.addEventListener("click",S),l.addEventListener("change",q),f.addEventListener("change",L)},uploadAdForm:_}})(),window.modals={showDialogMessage:function(e,t="",n){function o(){window.utils.removeElements(document.body.querySelectorAll(".user-message-active")),document.removeEventListener("click",r),document.removeEventListener("keydown",i)}function r(e){o(),n&&e.target.matches("button")&&n()}function i(e){"Escape"===e.key&&o()}const a=document.querySelector("#"+e).content.querySelector("."+e).cloneNode(!0);a.querySelector(`.${e}__message`).textContent=t,a.classList.add("user-message-active"),document.body.prepend(a),document.addEventListener("click",r),document.addEventListener("keydown",i)}},(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main");window.map.deactivateMap(),window.form.setFormInactiveMode(),t.addEventListener("mousedown",(function(n){if(0!==n.button)return;n.preventDefault();let o={x:n.clientX,y:n.clientY};function r(e){e.preventDefault();let n=o.x-e.clientX,r=o.y-e.clientY;o={x:e.clientX,y:e.clientY},function(){const e=document.querySelector(".map__overlay");window.data.ADS_DATA.LOCATION_X.min=0-t.offsetWidth/2,window.data.ADS_DATA.LOCATION_X.max=e.offsetWidth-t.offsetWidth/2}(),t.style.top=window.data.checkInterval("LOCATION_Y",t.offsetTop-r)+"px",t.style.left=window.data.checkInterval("LOCATION_X",t.offsetLeft-n)+"px"}document.addEventListener("mousemove",r),document.addEventListener("mouseup",(function t(n){n.preventDefault(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",t),e.matches(".map--faded")?(window.map.activateMap(),window.form.setFormActiveMode()):window.map.updateMap()}))}))})()})();